const charMap = {
	"char": { "x": 0, "y": 0, "w": 1000, "h": 1000, "components": [
		{ "key": "c", "filename":"c_qiaqi_l", "unicode": 1000, "width": 1000},
		{ "key": "d", "filename":"d_zhong_l", "unicode": 1001, "width": 1000},
		{ "key": "f", "filename":"f_index_l", "unicode": 1002, "width": 1000},
		{ "key": "H", "filename":"H_cuo_l", "unicode": 1003, "width": 1000},
		{ "key": "h", "filename":"h_tuo_l", "unicode": 1004, "width": 1000},
		{ "key": "I", "filename":"I_dacuo_l", "unicode": 1005, "width": 1000},
		{ "key": "i", "filename":"i_ti_l", "unicode": 1006, "width": 1000},
		{ "key": "j", "filename":"j_mo_l", "unicode": 1007, "width": 1000},
		{ "key": "k", "filename":"k_gou_l", "unicode": 1008, "width": 1000},
		{ "key": "l", "filename":"l_da_l", "unicode": 1009, "width": 1000},
		{ "key": "n", "filename":"n_bo_l", "unicode": 1010, "width": 1000},
		{ "key": "O", "filename":"O_fancuo_l", "unicode": 1011, "width": 1000},
		{ "key": "o", "filename":"o_zhai_l", "unicode": 1012, "width": 1000},
		{ "key": "s", "filename":"s_ming_l", "unicode": 1013, "width": 1000},
		{ "key": "U", "filename":"U_fancuo_l", "unicode": 1014, "width": 1000},
		{ "key": "u", "filename":"u_tiao_l", "unicode": 1015, "width": 1000},
		{ "key": "v", "filename":"v_da_l", "unicode": 1016, "width": 1000},
		{ "key": "V", "filename":"V_yan_l", "unicode": 1017, "width": 1000},
		{ "key": "x", "filename":"x_gui_l", "unicode": 1018, "width": 1000}
	]},
	"lhHalf": { "x": 100, "y": 100, "w": 374, "h": 305, "components": [
		{ "key": "v", "filename": "v_da_s", "unicode": 1019, "width": 0},
		{ "key": "f", "filename": "f_index_s", "unicode": 1020, "width": 0},
		{ "key": "d", "filename": "d_zhong_s", "unicode": 1021, "width": 0},
		{ "key": "s", "filename": "s_ming_s", "unicode": 1022, "width": 0},
		{ "key": "x", "filename": "x_gui_s", "unicode": 1023, "width": 0},
	]},
	"huiHalf": { "x": 500, "y": 100, "w": 400, "h": 305, "components": [
		{ "key": "1", "filename": "1_yi_s", "unicode": 1024, "width": 0 },
		{ "key": "2", "filename": "2_er_s", "unicode": 1025, "width": 0 },
		{ "key": "3", "filename": "3_san_s", "unicode": 1026, "width": 0 },
		{ "key": "4", "filename": "4_si_s", "unicode": 1027, "width": 0 },
		{ "key": "5", "filename": "5_wu_s", "unicode": 1028, "width": 0 },
		{ "key": "6", "filename": "6_liu_s", "unicode": 1029, "width": 0 },
		{ "key": "7", "filename": "7_qi_s", "unicode": 1030, "width": 0 },
		{ "key": "8", "filename": "8_ba_s", "unicode": 1031, "width": 0 },
		{ "key": "9", "filename": "9_jiu_s", "unicode": 1032, "width": 0 },
		{ "key": "10", "filename": "10_shi_s", "unicode": 1033, "width": 0 },
	]},
	"huiHalfTop": { "x": 500, "y": 100, "w": 400, "h": 150, "components": [
		{ "key": "1", "filename": "1_yi_s", "unicode": 1034, "width": 0 },
		{ "key": "2", "filename": "2_er_s", "unicode": 1035, "width": 0 },
		{ "key": "3", "filename": "3_san_s", "unicode": 1036, "width": 0 },
		{ "key": "4", "filename": "4_si_s", "unicode": 1037, "width": 0 },
		{ "key": "5", "filename": "5_wu_s", "unicode": 1038, "width": 0 },
		{ "key": "6", "filename": "6_liu_s", "unicode": 1039, "width": 0 },
		{ "key": "7", "filename": "7_qi_s", "unicode": 1040, "width": 0 },
		{ "key": "8", "filename": "8_ba_s", "unicode": 1041, "width": 0 },
		{ "key": "9", "filename": "9_jiu_s", "unicode": 1042, "width": 0 },
		{ "key": "10", "filename": "10_shi_s", "unicode": 1043, "width": 0 }
	]},
	"huiHalfBottom": { "x": 500, "y": 255, "w": 400, "h": 150, "components": [
		{ "key": "1", "filename": "1_yi_s", "unicode": 1044, "width": 0 },
		{ "key": "2", "filename": "2_er_s", "unicode": 1045, "width": 0 },
		{ "key": "3", "filename": "3_san_s", "unicode": 1046, "width": 0 },
		{ "key": "4", "filename": "4_si_s", "unicode": 1047, "width": 0 },
		{ "key": "5", "filename": "5_wu_s", "unicode": 1048, "width": 0 },
		{ "key": "6", "filename": "6_liu_s", "unicode": 1049, "width": 0 },
		{ "key": "7", "filename": "7_qi_s", "unicode": 1050, "width": 0 },
		{ "key": "8", "filename": "8_ba_s", "unicode": 1051, "width": 0 },
		{ "key": "9", "filename": "9_jiu_s", "unicode": 1052, "width": 0 }
	]},
	"rhHalf": { "x": 100, "y": 431, "w": 800, "h": 469, "components": [
		{ "key": "n", "filename": "n_bo_m", "unicode": 1053, "width": 0 },
		{ "key": "h", "filename": "h_tuo_m", "unicode": 1054, "width": 0 },
		{ "key": "u", "filename": "u_tiao_m", "unicode": 1055, "width": 0 },
		{ "key": "k", "filename": "k_gou_m", "unicode": 1056, "width": 0 },
		{ "key": "i", "filename": "i_ti_m", "unicode": 1057, "width": 0 },
		{ "key": "l", "filename": "l_da_m", "unicode": 1058, "width": 0 },
		{ "key": "o", "filename": "o_zhai_m", "unicode": 1059, "width": 0 },
		{ "key": "c", "filename": "c_qiaqi_m", "unicode": 1060, "width": 0 }
	]},
	"strHalf": { "x": 245, "y": 540, "w": 520, "h": 230 , "components": [
		{ "key": "1", "filename": "1_yi_m", "unicode": 1061, "width": 0 },
		{ "key": "2", "filename": "2_er_m", "unicode": 1062, "width": 0 },
		{ "key": "3", "filename": "3_san_m", "unicode": 1063, "width": 0 },
		{ "key": "4", "filename": "4_si_m", "unicode": 1064, "width": 0 },
		{ "key": "5", "filename": "5_wu_m", "unicode": 1065, "width": 0 },
		{ "key": "6", "filename": "6_liu_m", "unicode": 1066, "width": 0 },
		{ "key": "7", "filename": "7_qi_m", "unicode": 1067, "width": 0 }
	]},
	"thirdMidFull": { "x": 300, "y": 420, "w": 400, "h": 240, "components": [
		{ "key": "j", "filename": "j_mo_s", "unicode": 1068, "width": 0 },
		{ "key": "V", "filename": "V_yan_s", "unicode": 1069, "width": 0 },
		{ "key": "0", "filename": "0_san_m", "unicode": 1070, "width": 0 }
	]},
	"thirdMidLeft": { "x": 260, "y": 420, "w": 230, "h": 230, "components": [
		{ "key": "v", "filename": "v_da_s", "unicode": 1071, "width": 0},
		{ "key": "f", "filename": "f_index_s", "unicode": 1072, "width": 0},
		{ "key": "d", "filename": "d_zhong_s", "unicode": 1073, "width": 0},
		{ "key": "s", "filename": "s_ming_s", "unicode": 1074, "width": 0},
		{ "key": "x", "filename": "x_gui_s", "unicode": 1075, "width": 0}
	]},
	"thirdMidRight": { "x": 500, "y": 420, "w": 230, "h": 230, "components": [
		{ "key": "1", "filename": "1_yi_s", "unicode": 1076, "width": 0 },
		{ "key": "2", "filename": "2_er_s", "unicode": 1077, "width": 0 },
		{ "key": "3", "filename": "3_san_s", "unicode": 1078, "width": 0 },
		{ "key": "4", "filename": "4_si_s", "unicode": 1079, "width": 0 },
		{ "key": "5", "filename": "5_wu_s", "unicode": 1080, "width": 0 },
		{ "key": "6", "filename": "6_liu_s", "unicode": 1081, "width": 0 },
		{ "key": "7", "filename": "7_qi_s", "unicode": 1082, "width": 0 },
		{ "key": "8", "filename": "8_ba_s", "unicode": 1083, "width": 0 },
		{ "key": "9", "filename": "9_jiu_s", "unicode": 1084, "width": 0 },
		{ "key": "10", "filename": "10_shi_s", "unicode": 1085, "width": 0 }
	]},
	"rhThirdBottom": { "x": 100, "y": 660, "w": 800, "h": 305, "components": [
		{ "key": "n", "filename": "n_bo_m", "unicode": 1086, "width": 0 },
		{ "key": "h", "filename": "h_tuo_m", "unicode": 1087, "width": 0 },
		{ "key": "u", "filename": "u_tiao_m", "unicode": 1088, "width": 0 },
		{ "key": "k", "filename": "k_gou_m", "unicode": 1089, "width": 0 },
		{ "key": "i", "filename": "i_ti_m", "unicode": 1090, "width": 0 },
		{ "key": "l", "filename": "l_da_m", "unicode": 1091, "width": 0 },
		{ "key": "o", "filename": "o_zhai_m", "unicode": 1092, "width": 0 }
	]},
	"strThird": { "x": 230, "y": 690, "w": 540, "h": 250, "components": [
		{ "key": "1", "filename": "1_yi_l", "unicode": 1093, "width": 0 },
		{ "key": "2", "filename": "2_er_l", "unicode": 1094, "width": 0 },
		{ "key": "3", "filename": "3_san_l", "unicode": 1095, "width": 0 },
		{ "key": "4", "filename": "4_si_l", "unicode": 1096, "width": 0 },
		{ "key": "5", "filename": "5_wu_l", "unicode": 1097, "width": 0 },
		{ "key": "6", "filename": "6_liu_l", "unicode": 1098, "width": 0 },
		{ "key": "7", "filename": "7_qi_l", "unicode": 1099, "width": 0 }
	]},
	"halfUpper": { "x": 373, "y": 373, "w": 260, "h": 145, "components": [
		{ "key": "/", "filename": "fwdSlash_shang_s", "unicode": 1100, "width": 0 }
	]},
	"halfLeft": { "x": 0, "y": 430, "w": 100, "h": 500, "components": [
		{ "key": "\\", "filename": "bckSlash_xia_m", "unicode": 1101, "width": 0 }
	]},
	"huiHalfFull": { "x": 100, "y": 100, "w": 800, "h": 305, "components": [
		{ "key": "0", "filename": "0_san_m", "unicode": 1102, "width": 0 }
	]},
	"cuo": { "x": 450, "y": -175, "w": 825, "h": 1175, "components": [
		{ "key": "H", "filename": "H_cuo_m", "unicode": 1103, "width": 667 },
		{ "key": "U", "filename": "U_fancuo_m", "unicode": 1104, "width": 667 },
		{ "key": "I", "filename": "I_dacuo_m", "unicode": 1105, "width": 667 },
		{ "key": "O", "filename": "O_dafancuo_m", "unicode": 1106, "width": 667 },
	]}
}
const structure = {
	doFor: /.*/,
	do: [
		{ regex: /[0-9]/, area: 'strHalf'},
		{ regex: /\(\d+\)/,
			doFor: /\(\d+\)/,
			do: [
				{ regex: /(?<=\().*(?=\))/, area: 'huiHalf' }
			]
		},
		{ regex: /\(.*\..\)/, 
			doFor: /\(.*\..\)/,
			do: [
				{ regex: /(?<=\().*(?=\.)/, area: 'huiHalfTop' },
				{ regex: /(?<=\.).*(?=\))/, area: 'huiHalfBottom' }
			]
		},
		{ regex: /(s|d|v|f|x)/, area: 'lhHalf'},
		{ regex: /(n|k|l|h|u|i|o|c)/, area: 'rhHalf'},
		{ regex: /j|V/, area: 'thirdMidFull', 
			doFor: /.*/,
			do: [
				{ regex: /[0-9]/, area: 'strThird'},
				{ regex: /(n|k|l|h|u|i|o|c)/, area: 'rhThirdBottom'}
			]
		},
		{ regex: /\(0\)/, 
			doFor: /\(0\)/,
			do: [
				{ regex: /0/, area: 'huiHalfFull'}
			]
		},
		{ regex: /\//, area: 'halfUpper' },
		{ regex: /\\/, area: 'halfLeft'  },
		{ regex: /H|U|I|O/, area: 'cuo', 
			doFor: /[^H|U|I|O]*/i,
			do: [
				{ regex: /[0-9]/, area: 'strHalf' },
				{ regex: /(s|d|v|f|x)|(\([0-9].*\))/,
					doFor: /.*/,
					do: [
						{ regex: /[0-9]/, area: 'strThird'},
						{ regex: /s|d|v|f|x/, area: 'thirdMidLeft' },
						{ regex: /(?<=\().*(?=\))/, area: 'thirdMidRight' },
						{ regex: /\(0\)/, 
							doFor: /.*/,
							do: [
								{ regex: /0/, area: 'thirdMidFull'}
							]
						},
					]
				}
			]
		},
		{ regex: /H|U|I|O/, area: 'cuo', 
			doFor: /[H|U|I|O](.*)/,
			do: [
				{ regex: /[0-9]/, area: 'strHalf' },
				{ regex: /(s|d|v|f|x)|(\([0-9].*\))/,
					doFor: /.*/,
					do: [
						{ regex: /[0-9]/, area: 'strThird'},
						{ regex: /s|d|v|f|x/, area: 'thirdMidLeft' },
						{ regex: /(?<=\().*(?=\))/, area: 'thirdMidRight' },
						{ regex: /\(0\)/, 
							doFor: /.*/,
							do: [
								{ regex: /0/, area: 'thirdMidFull'}
							]
						},
					]
				}
			]
		},
	]
}

DEBUG = false

////////////////////////////////////////////////////////////////////////

String.prototype.contains = function(str) {
	if (typeof str == 'string') {
		if (this.indexOf(str) > -1)
			return true
		else
			return false
	}
	else if (typeof str == 'object') {
		for (var i=0;i<str.length;i++) {
			if (this.indexOf(str[i]) > -1) 
				return true
		}
		return false
	}
}
String.prototype.replaceAll = function(replaceThis, withThis) {
	return this.split(replaceThis).join(withThis)
}
function removeItemAll(arr, value) {
  var i = 0;
  while (i < arr.length) {
    if (arr[i] === value) {
      arr.splice(i, 1);
    } else {
      ++i;
    }
  }
  return arr;
}

////////////////////////////////////////////////////////////////////////

function getStructure(ogStr, structureMap) {
	var strMap = {}
	var str = ogStr.match(structureMap.doFor)[0]
	var startIdx = ogStr.match(structureMap.doFor).index
	for (var i=0; i<structureMap.do.length; i++) {
		if (str.match(structureMap.do[i].regex)) {
			var matchInfo = str.match(structureMap.do[i].regex)
			if (matchInfo.index != undefined) {
				if (structureMap.do[i].area != undefined) {
					strMap[matchInfo.index + startIdx] = {
						chars: matchInfo[0],
						length: matchInfo[0].length, 
						area: structureMap.do[i].area
					}
				}
				if (structureMap.do[i].doFor != undefined) {
					subStrMap = getStructure(str, structureMap.do[i])
					for (var k in subStrMap) {
						strMap[Number(k) + startIdx] = subStrMap[k]
					}
					DEBUG ? console.log('subStrMap', subStrMap) : 0
				}
			}
			else if (false) { // for multimatches (e.g., with /g tag); ignoring for now tho
				var j=0
				while (j<100 && (matchPartInfo = structureMap.do[i].regex.exec(str)) != null) {
					strMap[matchInfo.index] = {
						chars: matchInfo[0],
						length: matchPartInfo[0].length, 
						areas: structureMap.do[i].areas
					}
					strMapAreas = strMapAreas.concat(structureMap.do[i].areas)
				  j++
				}
			}
		}
	}
	return strMap
}
function stringToCharacter(str) {
	str = str.replaceAll('V', 'Vv')
	var strMap = getStructure(str, structure)
	DEBUG ? console.log('strMap', strMap) : ''

	// get unicodes
	var character = '';
	for (var k in strMap) {
		for (var i=0;i<charMap[strMap[k].area].components.length; i++) {
			if (charMap[strMap[k].area].components[i].key == strMap[k].chars) {
				character += String.fromCharCode(charMap[strMap[k].area].components[i].unicode)
			}
		}
	}
	return character
}
function paragraphToCharacters(para) {
	var lines = para.split('\n')
	for (var j=0;j<lines.length; j++) {
		var words = lines[j].split(' ')
		for (var i=0;i<words.length;i++) {
			var cuo1, cuo2, translation
			if (false && words[i].split('H').length > 1) {
				cuo1 = words[i].split('H')[0]
				cuo2 = words[i].split('H')[1]
				translation = stringToCharacter(cuo1) + stringToCharacter('H') + stringToCharacter(cuo2)
			}
			else {
				translation = stringToCharacter(words[i])
			}
			words[i] = translation == '' ? words[i] : translation + ' '
		}
		lines[j] = words.join('')
	}
	return lines.join('\n')
}

////////////////////////////////////////////////////////////////////////

$(document).ready(function() {
	$('.jzp-use-brackets').each(function() {
		var newDivHTML = $(this).html()

		newDivHTML = newDivHTML.replaceAll('[[[', '<span class="jzp jzp-use-characters">')
			.replaceAll(']]]', '</span>')
		$(this).html(newDivHTML)

		newDivHTML = newDivHTML.replaceAll('[[', '<span class="jzp">')
			.replaceAll(']]', '</span>')

		$(this).html(newDivHTML)
		$(this).find('.jzp-use-characters').each(function() {
			$(this).text(paragraphToCharacters($(this).text()))
		})
	})
})
