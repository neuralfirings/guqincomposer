<!DOCTYPE html>
<html lang="en">
  <head>      
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Guqin Tablature Composer (easy Guqin Notation)</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="/lib/codemirror.js"></script>
    <link rel="stylesheet" href="/lib/codemirror.css">

    <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"></script>

    <script src="/utils.js"></script>
    <link rel="stylesheet" href="/style.css" />

    <script>
      {{variables}}

      String.prototype.has = function(thing) {
        if (this.indexOf(thing) > -1)
          return true
        else
          return false
      }

      String.prototype.getParentheticals = function() {
        var txt2 = this.split('(');
        var matches = []
        for (var i = 1; i < txt2.length; i++) {
            matches.push(txt2[i].split(')')[0]);
        }
        return matches
      }

      String.prototype.removeParentheses = function() {
        var txt2 = this.split('(');
        var newTxt = this
        var matches = []
        for (var i = 1; i < txt2.length; i++) {
            matches.push(txt2[i].split(')')[0]);
        }
        for (var i=0; i<matches.length;i++) {
          var rm = '(' + matches[i] + ')'
          newTxt = newTxt.split(rm).join('')
        }
        return newTxt
      }

      lyMapAndExtract = ['~', "=", "/", "\\", ">", "<"]
      lyMap = { 
        "0": { "type": "str", "value": 0 }, "1": { "type": "str", "value": 1 }, "2": { "type": "str", "value": 2 }, "3": { "type": "str", "value": 3 }, "4": { "type": "str", "value": 4 }, "5": { "type": "str", "value": 5 }, "6": { "type": "str", "value": 6 }, "7": { "type": "str", "value": 7 }, 
        "n": { "type": "rh", "value": "1v" }, "j": { "type": "rh", "value": "2v" }, "k": { "type": "rh", "value": "3v" }, "l": { "type": "rh", "value": "4v" }, ";": { "type": "rh", "value": "5v" }, 
        "h": { "type": "rh", "value": "1^" }, "u": { "type": "rh", "value": "2^" }, "i": { "type": "rh", "value": "3^" }, "o": { "type": "rh", "value": "4^" }, "p": { "type": "rh", "value": "5^" }, 
        "by": { "type": "rh", "value": "2^\"^\"3v" }, "yb": { "type": "rh", "value": "2^\"^\"3v" }, "b8": { "type": "rh", "value": "1^\"^\"3v" }, "8b": { "type": "rh", "value": "1^\"^\"3v" }, "b9": { "type": "rh", "value": "1v\"^\"3^" }, "9b": { "type": "rh", "value": "1v\"^\"3^" },  
        // "/": { "type": "lh", "value": "/" }, "\\": { "type": "lh", "value": "\\" }, 
        "g": { "type": "lh", "value": "1K" }, "w": { "type": "lh", "value": "4K" }, 
        "v": { "type": "lh", "value": 1 }, "f": { "type": "lh", "value": 2 }, "d": { "type": "lh", "value": 3 }, "s": { "type": "lh", "value": 4 }, "a": { "type": "lh", "value": 5 }, 
        "c": { "type": "lh", "value": "1v" }, "x": { "type": "lh", "value": "4G" }, "e": { "type": "lh", "value": "3^" }, 
        // "~": { "type": "lh", "value": "~" }, 
        "V": { "type": "lh", "value": "1X" }, "F": { "type": "lh", "value": "2X" }, "D": { "type": "lh", "value": "3X" }, "S": { "type": "lh", "value": "4X" }, "A": { "type": "lh", "value": "5X" } 
      }
      lyPitches = [ 'r',
        // 'aes','bes','ces','des','ees','fes','ges',
        'a','b','c','d','e','f','g'
      ]
      lyFanYins = [
        // 'A','B','C','D','E','FES','G',
        'A','B','C','D','E','F','G'
      ]
      lyBeats = ['1','2','3','4','5','6','7','8','9']
      tuningEqual = [0,13.6,13.1,12.2,10.9,10.0,9.5,9.0,8.4,7.9,7.6,7.3,7.0,6.7,6.5,6.2,6.0,5.6,5.3,5.0,4.8,4.6,4.4,4.2,4.0,3.7,3.5,3.2,3.0,2.6,2.3,2.0,1.8,1.6,1.4,1.2,1.0]
      tuningJust = [0,13.6,13.1,12.2,11.0,10.0,9.5,9.0,8.5,8.0,7.7,7.3,7.0,6.7,6.4,6.2,6.0,5.6,5.3,5.0,4.8,4.6,4.4,4.2,4.0,3.7,3.4,3.2,3.0,2.6,2.3,2.0,1.8,1.6,1.4,1.2,1.0]
      harmonics = []
        harmonics[2*6]=[7]
        harmonics[2*9.5]=[5,9]
        harmonics[2*12]=[4,10]
        harmonics[2*14]=[3, 6, 8, 11,]
        harmonics[2*15.5]=[2,12]
        harmonics[2*17]=[1.4,4.4,6.3,7.7,9.6,12.6]
        harmonics[2*18]=[1,5.6,8.4,13]
        harmonics[2*19]=[0.9,3.4,6.4,7.6,10.6,13.1]
        harmonics[2*20]=[0.8,4.6,9.4,13.2]

      var lyStr1 = "% v8\nlm = #(define-music-function (note) (ly:music?) #{  \\override NoteHead.style = #'cross $note \\revert NoteHead.style #} )\nfy = #(define-music-function (pos note) ((number? 1) ly:music?) (let ( (stringNum (ly:prob-property (list-ref (ly:music-property note 'articulations) 0) 'string-number)) (tuning "
      // var lyStr1 = "% v8\nlm = #(define-music-function (note) (ly:music?) #{  \\override NoteHead.style = #'cross $note \\revert NoteHead.style #} )\nfy = #(define-music-function (pos note) ((number? 1) ly:music?) (let ( (stringNum (ly:prob-property (list-ref (ly:music-property note 'articulations) 0) 'string-number)) (tuning "
      // var lystr2 = ") (let ( (base (list-ref tuning stringNum)) ) (define noteP (ly:music-property note 'pitch)) (define baseP (ly:music-property base 'pitch)) (define intNote (ly:pitch-diff (ly:music-property base 'pitch) (ly:music-property note 'pitch) )) (define interval (ly:pitch-tones (ly:pitch-diff (ly:music-property note 'pitch) (ly:music-property base 'pitch)))) (cond ( (= interval 6 ) #{ \\transpose c f, { \\harmonicByFret #7 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 9.5 ) (> pos 1)) #{ \\transpose c g, { \\harmonicByFret #5 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 9.5 ) (= pos 1)) #{ \\transpose c ees, { \\harmonicByFret #9 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 12 ) (> pos 1)) #{ \\transpose c aes, { \\harmonicByFret #4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 12 ) (= pos 1)) #{ \\transpose c c'' { \\harmonicByFret #10 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (> pos 3)) #{ \\transpose c a, { \\harmonicByFret #3 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 3)) #{ \\transpose c e'' { \\harmonicByFret #6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 2)) #{ \\transpose c e'' { \\harmonicByFret #8 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 1)) #{ \\transpose c e'' { \\harmonicByFret #11 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 15.5 ) (> pos 1)) #{ \\transpose c f, { \\harmonicByFret #2 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 15.5 ) (= pos 1)) #{ \\transpose c g' { \\harmonicByFret #12 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (> pos 5)) #{ \\transpose c bes'' { \\harmonicByFret #1.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 5)) #{ \\transpose c bes'' { \\harmonicByFret #4.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 4)) #{ \\transpose c bes'' { \\harmonicByFret #6.3 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 3)) #{ \\transpose c bes'' { \\harmonicByFret #7.7 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 2)) #{ \\transpose c bes'' { \\harmonicByFret #9.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 1)) #{ \\transpose c bes'' { \\harmonicByFret #12.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (> pos 3)) #{ \\transpose c c''' { \\harmonicByFret #1 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 3)) #{ \\transpose c c''' { \\harmonicByFret #5.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 2)) #{ \\transpose c c''' { \\harmonicByFret #8.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 1)) #{ \\transpose c c''' { \\harmonicByFret #13 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (> pos 5)) #{ \\transpose c d''' { \\harmonicByFret #0.9 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 5)) #{ \\transpose c d''' { \\harmonicByFret #3.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 4)) #{ \\transpose c d''' { \\harmonicByFret #6.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 3)) #{ \\transpose c d''' { \\harmonicByFret #7.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 2)) #{ \\transpose c d''' { \\harmonicByFret #10.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 1)) #{ \\transpose c d''' { \\harmonicByFret #13.1 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (> pos 3)) #{ \\transpose c e''' { \\harmonicByFret #0.8 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 3)) #{ \\transpose c e''' { \\harmonicByFret #4.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 2)) #{ \\transpose c e''' { \\harmonicByFret #9.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 1)) #{ \\transpose c e''' { \\harmonicByFret #13.2 $(ly:music-transpose note intNote) } #} ) ( else #{ $note #} ) ) ) ) )"
      var lyStr2 = ") (let ( (base (list-ref tuning stringNum)) ) (define noteP (ly:music-property note 'pitch)) (define baseP (ly:music-property base 'pitch)) (define intNote (ly:pitch-diff (ly:music-property base 'pitch) (ly:music-property note 'pitch) )) (define interval (ly:pitch-tones (ly:pitch-diff (ly:music-property note 'pitch) (ly:music-property base 'pitch)))) (cond ( (= interval 6 ) #{ \\transpose c f, { \\harmonicByFret #7 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 9.5 ) (= pos 5)) #{ \\transpose c g, { \\harmonicByFret #5 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 9.5 ) (= pos 9)) #{ \\transpose c ees, { \\harmonicByFret #9 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 9.5 ) (= pos 1)) #{ \\transpose c g, { \\harmonicByFret #5 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 12 ) (= pos 4)) #{ \\transpose c aes, { \\harmonicByFret #4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 12 ) (= pos 10)) #{ \\transpose c c'' { \\harmonicByFret #10 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 12 ) (= pos 1)) #{ \\transpose c aes, { \\harmonicByFret #4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 3)) #{ \\transpose c a, { \\harmonicByFret #3 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 6)) #{ \\transpose c e'' { \\harmonicByFret #6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 8)) #{ \\transpose c e'' { \\harmonicByFret #8 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 11)) #{ \\transpose c e'' { \\harmonicByFret #11 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 14 ) (= pos 1)) #{ \\transpose c e'' { \\harmonicByFret #6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 15.5 ) (= pos 2)) #{ \\transpose c f, { \\harmonicByFret #2 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 15.5 ) (= pos 12)) #{ \\transpose c g' { \\harmonicByFret #12 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 15.5 ) (= pos 1)) #{ \\transpose c f, { \\harmonicByFret #2 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 1.4)) #{ \\transpose c bes'' { \\harmonicByFret #1.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 4.4)) #{ \\transpose c bes'' { \\harmonicByFret #4.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 6.3)) #{ \\transpose c bes'' { \\harmonicByFret #6.3 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 7.7)) #{ \\transpose c bes'' { \\harmonicByFret #7.7 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 9.6)) #{ \\transpose c bes'' { \\harmonicByFret #9.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 12.6)) #{ \\transpose c bes'' { \\harmonicByFret #12.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 17 ) (= pos 1)) #{ \\transpose c bes'' { \\harmonicByFret #6.3 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 1)) #{ \\transpose c c''' { \\harmonicByFret #1 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 5.6)) #{ \\transpose c c''' { \\harmonicByFret #5.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 8.4)) #{ \\transpose c c''' { \\harmonicByFret #8.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 18 ) (= pos 13)) #{ \\transpose c c''' { \\harmonicByFret #13 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 0.9)) #{ \\transpose c d''' { \\harmonicByFret #0.9 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 3.4)) #{ \\transpose c d''' { \\harmonicByFret #3.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 6.4)) #{ \\transpose c d''' { \\harmonicByFret #6.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 7.6)) #{ \\transpose c d''' { \\harmonicByFret #7.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 10.6)) #{ \\transpose c d''' { \\harmonicByFret #10.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 13.1)) #{ \\transpose c d''' { \\harmonicByFret #13.1 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 19 ) (= pos 1)) #{ \\transpose c d''' { \\harmonicByFret #6.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 0.8)) #{ \\transpose c e''' { \\harmonicByFret #0.8 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 4.6)) #{ \\transpose c e''' { \\harmonicByFret #4.6 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 9.4)) #{ \\transpose c e''' { \\harmonicByFret #9.4 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 13.2)) #{ \\transpose c e''' { \\harmonicByFret #13.2 $(ly:music-transpose note intNote) } #} ) ( (and (= interval 20 ) (= pos 1)) #{ \\transpose c e''' { \\harmonicByFret #4.6 $(ly:music-transpose note intNote) } #} ) ( else #{ $note #} ) ) ) ) )"
      var lyStr3 = `tuningEqual = #'("0" "13.6"  "13.1"  "12.2"  "10.9"  "10"  "9.5"  "9"  "8.4"  "7.9"  "7.6"  "7.3"  "7"  "6.7"  "6.5"  "6.2"  "6"  "5.6"  "5.3"  "5"  "4.8"  "4.6"  "4.4"  "4.2"  "4"  "3.7"  "3.5"  "3.2"  "3"  "2.6"  "2.3"  "2"  "1.8"  "1.6"  "1.4"  "1.2"  "1")\ntuningJust = #'("0" "13.6" "13.1" "12.2" "11" "10" "9.5" "9" "8.5" "8" "7.7" "7.3" "7" "6.7" "6.4" "6.2" "6" "5.6" "5.3" "5" "4.8" "4.6" "4.4" "4.2" "4" "3.7" "3.4" "3.2" "3" "2.6" "2.3" "2" "1.8" "1.6" "1.4" "1.2" "1")`
      var lyStr4 = `\\layout { \\context { \\TabStaff stringTunings = \\stringTuning \\tuning fretLabels = \\tuningEqual }`
      var lyStr5 = `\\context { \\Score \\override RehearsalMark.self-alignment-X = #LEFT \\override RehearsalMark.font-size = #-1 } \\context { \\Staff \\hide TextScript \\override TrillSpanner.bound-details.left.text = ##f \\override Glissando.style = #'zigzag }`
      var lyStr6 = `\\context { \\TabStaff \\omit Clef   \\revert TextScript.stencil \\override TextScript.font-size = #-3 \\override Glissando.style = #'zigzag \\override TabNoteHead.font-family = #'typewriter tablatureFormat = #fret-letter-tablature-format } \\textLengthOn \\omit Voice.StringNumber } \\midi {}`
      var lyStr7 = `<< \\new Staff  { \\song } \\new TabStaff { \\clef "moderntab" \\song } >>`


      function getPressedPosition(note,str) {
        if (tuning == undefined || tuning == '')
          var tuning = ['g,', 'a,', 'c', 'd', 'e', 'g', 'a']
        var tuningMethod = tuningEqual
        var chromatic = {"ces": -1,"c": 0,"cis": 1 ,"des": 1,"d": 2,"dis": 3,"ees": 3,"e": 4,"eis": 5,"fes": 4,"f": 5,"fis": 6 ,"ges": 6,"g": 7,"aes": 8,"gis": 8 ,"a": 9,"ais": 10 ,"bes": 10,"b": 11,"bis": 12}

        var pitch = note.split("'")[0].split(',')[0]
        var octUp = note.split("'").length-1
        var octDown = note.split(",").length-1
        var pitchNum = chromatic[pitch] + octUp*12 - octDown*12

        var pitchStr = tuning[str-1].split("'")[0].split(',')[0]
        var pitchStrNum = chromatic[pitchStr] + (tuning[str-1].split("'").length-1)*12 - (tuning[str-1].split(',').length-1)*12

        var dist = pitchNum-pitchStrNum
        if (dist < 0 || dist >= tuningMethod.length) {
          return false
        }
        else {
          return tuningMethod[dist]
        }
      }

      function getHarmonicPositions(note,str,tuning) {
        note=note.toLowerCase()
        if (typeof tuning == "undefined")
          var tuning = ['g,', 'a,', 'c', 'd', 'e', 'g', 'a']
        var tuningMethod = harmonics
        var chromatic = {"ces": -1,"c": 0,"cis": 1 ,"des": 1,"d": 2,"dis": 3,"ees": 3,"e": 4,"eis": 5,"fes": 4,"f": 5,"fis": 6 ,"ges": 6,"g": 7,"aes": 8,"gis": 8 ,"a": 9,"ais": 10 ,"bes": 10,"b": 11,"bis": 12}

        var pitch = note.split("'")[0].split(',')[0]
        var octUp = note.split("'").length-1
        var octDown = note.split(",").length-1
        var pitchNum = chromatic[pitch] + octUp*12 - octDown*12

        var pitchStr = tuning[str-1].split("'")[0].split(',')[0]
        var pitchStrNum = chromatic[pitchStr] + (tuning[str-1].split("'").length-1)*12 - (tuning[str-1].split(',').length-1)*12

        var dist = pitchNum-pitchStrNum
        if (tuningMethod[dist] == undefined) {
          return []
        }
        else {
          if (tuningMethod)
          return tuningMethod[dist]
        }
      }
      function getNumOnly(str) {
        newStr = ""
        valNums = ['0','1','2','3','4','5','6','7','8','9']
        for (var i=0;i<str.length;i++) {
          if (valNums.indexOf(str[i]) > -1)
            newStr += str[i]
        }
        return newStr
      }
      function removeNums(str) {
        newStr = ""
        valNums = ['0','1','2','3','4','5','6','7','8','9']
        for (var i=0;i<str.length;i++) {
          if (valNums.indexOf(str[i]) == -1)
            newStr += str[i]
        }
        return newStr
      }
      String.prototype.beginsWith = function(str) {
        if (this.substring(0, str.length) == str)
          return true;
        else
          return false
      }
      $(document).ready(function() {
        currWidth = 100
        if (session.hasPDF) {
          $('.download-pdf').attr('href', `/nltabfiles/${session.id}/${session.version}/music.pdf`)
          $('.score-container').show()
        }
        if (session.hasMIDI) {
          $('.download-midi').attr('href', `/nltabfiles/${session.id}/${session.version}/music.midi`)
          $('.midi-player').attr('src', `/nltabfiles/${session.id}/${session.version}/music.midi`)
          $('.score-container').show()
        }
        if (session.hasPNG) {
          for (var i=0;i<session.PNGs.length;i++) {
            $('.score-pngs').append(`<img class="png" src="/nltabfiles/${session.id}/${session.version}/${session.PNGs[i]}" />`)
          }
          $('.score-container').show()
        }
        if (session.id != 'new') {
          $('.link').val(window.location.origin + '/nltabs/' + session.id)
          $('.lock').show()
          $('.unlock').hide()
        }
        else {
          $('.unlock').hide()
          $('.lock').hide()
          $('.save-new').hide()
          $('.save-keep-version').hide()
        }

        $('.render').click(function() {
          var to = $(this).attr('data-to')
          var from = $(this).attr('data-from')
          $('.rendering').show()

          if (from == 'shorthand') {
            console.log('shorthand > lilypond')
            var shortHand = shCodeMirror.getValue() // $('.shorthand').val()
            var shortHandLines = shortHand.split('\n')
            var tuning=''
            var composer='' 
            var title=''
            var bars=''
            var showtimesig=''

            // { parse the song
              var song = []
              var songLineIdx = []
              nCtr = 0
              fCtr = 0
              for (var i=0;i<shortHandLines.length;i++) {
                // shortHandLines[i] = shortHandLines[i].split("|").join(' ')
                if (shortHandLines[i].split('//').length>1)
                  shortHandLines[i] =   shortHandLines[i].split('//')[0]
                if (shortHandLines[i].trim() != "") {
                  if (shortHandLines[i].beginsWith("tuning:")) {
                    var tuningStr = shortHandLines[i].split('tuning:')[1]
                    tuning = tuningStr.trim().split(' ')
                  }
                  else if (shortHandLines[i].beginsWith('showtimesig:')) {
                    showtimesig = shortHandLines[i].split('showtimesig:')[1].trim()
                  }
                  else if (shortHandLines[i].beginsWith("bars:")) {
                    var barsString = shortHandLines[i].split('bars:')[1]
                    bars = barsString.trim()
                  }
                  else if (shortHandLines[i].beginsWith("composer:")) {
                    var composer = '\\markup \\right-column {"' + shortHandLines[i].split('composer:')[1].trim().split('\\n').join('" "') + '" }'
                  }
                  else if (shortHandLines[i].beginsWith("tuninglabel:")) {
                    var tuninglabel = '\\markup \\left-column {"' + shortHandLines[i].split('tuninglabel:')[1].trim().split('\\n').join('" "') + '" }'
                  }
                  else if (shortHandLines[i].beginsWith("title:")) {
                    var title = '\\markup \\center-column {"' + shortHandLines[i].split('title:')[1].trim().split('\\n').join('" "') + '" }'
                  }
                  // else if (shortHandLines[i].beginsWith("title:")) {
                  //   var titleStr = shortHandLines[i].split('title:')[1]
                  //   title = titleStr.trim()
                  // }
                  else if (shortHandLines[i].beginsWith('time:')) {
                    song.push("time:" + shortHandLines[i].split('time:')[1].trim())
                    songLineIdx.push(i)
                    nCtr++
                    fCtr++
                  }
                  else if (shortHandLines[i].beginsWith('tempo:')) {
                    song.push("tempo:" + shortHandLines[i].split('tempo:')[1].trim())
                    songLineIdx.push(i)
                    nCtr++
                    fCtr++
                  }
                  else if (shortHandLines[i].beginsWith('clef:')) {
                    song.push("clef:" + shortHandLines[i].split('clef:')[1].trim())
                    songLineIdx.push(i)
                    nCtr++
                    fCtr++
                  }
                  else if (shortHandLines[i].beginsWith('mark:')) {
                    song.push("mark:" + shortHandLines[i].split('mark:')[1].trim())
                    songLineIdx.push(i)
                    nCtr++
                    fCtr++
                  }
                  else if (shortHandLines[i].beginsWith('ly:')) {
                    song.push("ly:" + shortHandLines[i].split('ly:')[1].trim())
                    songLineIdx.push(i)
                    nCtr++
                    fCtr++
                  }
                  else if (shortHandLines[i].beginsWith('fyhuirange:')) {
                    song.push("fyhuirange:" + shortHandLines[i].split('fyhuirange:')[1].trim())
                    songLineIdx.push(i)
                    nCtr++
                    fCtr++
                  }
                  else if (shortHandLines[i].beginsWith("n:")) {
                    var noteStr = shortHandLines[i].split('n:')[1]
                    // noteStr = noteStr.split('-').join(' -')
                    noteStr = noteStr.replace(/ +(?= )/g,'');
                    var notes = noteStr.trim().split(' ') //split(/[\s-]+/) 
                    for (var j=0; j<notes.length; j++) {
                      song[nCtr] = (song[nCtr] == undefined ?  notes[j] : notes[j] + ':' + song[nCtr])
                      songLineIdx[nCtr] = i
                      nCtr++
                    }
                  }
                  else if (shortHandLines[i].beginsWith("f:")) {
                    var fingerStr = shortHandLines[i].split('f:')[1]
                    // fingerStr = fingerStr.split('-').join(' -')
                    fingerStr = fingerStr.replace(/ +(?= )/g,'');
                    var fingers = fingerStr.trim().split(' ')
                    for (var j=0; j<fingers.length; j++) {
                      song[fCtr] = (song[fCtr] == undefined ? fingers[j] : song[fCtr] + ':' + fingers[j])
                      songLineIdx[fCtr] = i
                      fCtr++
                    }
                  }
                }
                else {
                  song.push('linebreak')
                  songLineIdx.push(i)
                  fCtr++
                  nCtr++
                }
              }
              // console.log(song)
            // }

            // { render LilyPond from the song
              var fyhuirange = [7,4]
              var ly = ""
              ly += lyStr1 + ' '

              // { LilyPond tuning
                if (tuning == undefined || tuning == '')
                  tuning = ['g,', 'a,', 'c', 'd', 'e', 'g', 'a']

                ly+='(list #{c\\0#} ' //#{g'\6#} #{a'\7#} ))'
                for (var j=0;j<tuning.length;j++) {
                  // var notePlusOct
                  // if (tuning[j].length == 2 && tuning[j][1] == ",") {
                  //   notePlusOct = tuning[j][0]
                  // }
                  // else if (tuning[j][1] == ',') {
                  //   notePlusOct = tuning[j].substring(0, tuning[j].length-1)
                  // }
                  // else {
                  //   notePlusOct = tuning[j] + "'"
                  // }
                  // ly+='#{' + notePlusOct + '\\' + (j+1) + '#} '
                  ly+='#{' + tuning[j] + '\\' + (j+1) + '#} '
                }
                ly += ')) ' + lyStr2 + '\n'

                var tunReverse = JSON.parse(JSON.stringify(tuning)).reverse()
                ly += 'tuning = <' + tunReverse.join(' ') + '>\n'

                if (typeof tuninglabel == "undefined") {
                  var tuninglabel = "Tuning: " 
                  for (var j=0;j<tuning.length;j++) {
                    tuninglabel+=tuning[j].toUpperCase() + ' '
                  }
                  tuninglabel = '\\markup \\column {"' + tuninglabel + '"} '
                }
                // ly += "tuningLabel = \"Tuning: " 
                // for (var j=0;j<tuning.length;j++) {
                //   ly+=tuning[j].toUpperCase() + ' '
                // }
                ly+= '\n\n'
              // }

              ly += `#(set-default-paper-size "letter") \\header {\n  title = ${title}\n  composer =${composer}\n  poet =${tuninglabel}\n  tagline = "engraved by LilyPond using NL Tabs format (guqin.nyl.io)"\n}\n\n`

              // { song
                var lySong = ""
                var firstNote = true
                lySong += 'song = {\n' 
                lySong += '  \\clef "bass"\n'

                var rh, lh, str, prevStr
                guqin = []
                var startSlur = false
                var inSlur = false
                var endSlur = false
                var startGliss = false
                var inGliss = false
                var endGliss = false
                var prevRHF = -1
                // var prevFYHui = []
                for (var i=0; i<song.length; i++) {
                  if (song[i] == 'linebreak') {
                    lySong += '\n  '
                  }
                  else if (song[i].beginsWith('time:')) {
                    var time = song[i].split('time:')[1]
                    lySong += "\\time " + time + "\n  "
                  }
                  else if (song[i].beginsWith('tempo:')) {
                    var tempo = song[i].split('tempo:')[1]
                    lySong += "\\tempo " + tempo + "\n  "
                  }
                  else if (song[i].beginsWith('clef:')) {
                    var clef = song[i].split('clef:')[1]
                    lySong += '\\clef "' + clef + '"\n  '
                  }
                  else if (song[i].beginsWith('mark:')) {
                    var mark = song[i].split('mark:')[1]
                    lySong += '\\mark "' + mark + '"\n  '
                  }
                  else if (song[i].beginsWith('ly:')) {
                    lySong += song[i].split('ly:')[1]
                  }
                  else if (song[i].beginsWith('fyhuirange:')) {
                    fyhuirange = song[i].split('fyhuirange:')[1].split('-')
                  }
                  else {  
                    var note = song[i]
                    // { split note into note and guqin
                      var notePart = song[i].split(':')
                      var n = notePart[0]
                      if (firstNote) {
                        if (getNumOnly(n) == '')
                          n = n + "4"
                        firstNote = false
                      }
                      var gq = notePart[1]
                      if (typeof gq == 'undefined') {
                        console.log('error', i, song[i],  pitchArr)
                        alert(`error parsing note on line ${songLineIdx[i]+1} with note/finger combo: ${song[i]}.\n\nThere's likely a mismatch between note and finger positions.`)
                        $('.rendering').hide()
                        return
                      }

                      var isSlur = false
                      if (gq.indexOf('-') > -1) { // == '-') {
                        // gq = String(guqin[i-1].str[0])
                        if (!inSlur) {
                          startSlur = true
                          inSlur = true
                        }
                      }
                      else if (gq.indexOf('|') > -1) {
                        if (i+1 == song.length || song[i+1].split(':')[1] != '-') {
                          if (inSlur) {
                            inSlur = false
                            endSlur = true
                          }
                        }
                      }
                      else {
                        if (inSlur) {
                          inSlur = false
                          endSlur = true
                        }
                      }

                      var isGliss = false
                      if (n.indexOf('*') > -1) {
                        if (!inGliss) {
                          startGliss = true
                          inGliss = true 
                        }
                        n = n.split('*').join('')
                      }
                      else if (gq.indexOf('|') > -1) {
                        if (i+1 == song.length || song[i+1].split(':')[0].indexOf('*') == -1) {
                          if (inGliss) {
                            inGliss = false
                            endGliss = true
                          }
                        }
                      }
                      else {
                        if (inGliss) {
                          inGliss = false
                          endGliss = true
                        }
                      }
                    // }
                    
                    // { split note into chords (n --> noteArr)
                      var noteArr = []
                      var pitchArr = []
                      var beatArr = []
                      var rhythm = ""
                      var noteSplitStr = n 
                      for (var j=0;j<lyPitches.length;j++) {
                        noteSplitStr = noteSplitStr.split(lyPitches[j]).join("+" + lyPitches[j])
                      }
                      for (var j=0;j<lyFanYins.length;j++) {
                        noteSplitStr = noteSplitStr.split(lyFanYins[j]).join("+" + lyFanYins[j])
                      }
                      var idxBeat = -1
                      for (var j=0;j<noteSplitStr.length;j++) {
                        if (lyBeats.indexOf(noteSplitStr[j]) > -1) {
                          if (idxBeat == -1)
                            idxBeat = j 
                          else
                            idxBeat = Math.min(j, idxBeat)
                        }
                      }
                      if (idxBeat > -1)
                        noteSplitStr = noteSplitStr.substr(0,idxBeat) + "+" + noteSplitStr.substr(idxBeat, noteSplitStr.length)
                      // for (var j=0;j<lyBeats.length;j++) {
                      //   noteSplitStr = noteSplitStr.split(lyBeats[j]).join("+" + lyBeats[j])
                      // }
                      // combine sharps and flats
                      noteSplitStr = noteSplitStr.split('+es').join('es')
                        .split('+is').join('is')
                        .split('+ES').join('ES')
                        .split('+IS').join('IS')
                      noteArr = noteSplitStr.split('+')
                      for (var j=0;j<noteArr.length;j++) {
                        if (noteArr[j] != '') {
                          if (lyBeats.indexOf(noteArr[j][0]) > -1) {
                            beatArr.push(noteArr[j])
                          }
                          else if (lyPitches.indexOf(noteArr[j][0])> -1) {
                            pitchArr.push(noteArr[j])
                          }
                          else if (lyFanYins.indexOf(noteArr[j][0])> -1) {
                            pitchArr.push(noteArr[j])
                          }
                        }
                      }
                    // }

                    // { split guqin part into hands & strings (rh, lh, str array)
                      rh = []
                      lh = []
                      str = []
                      gq3 = ''
                      gq2 = ''
                      gq1 = ''
                      fyHuis = []

                      if (typeof gq != 'string')
                        console.log('error gq is not a string', song, note, i, gq, k)
                      else {
                        // { Custom RH/LH Lines
                          var customLH = false
                          var customRH = false
                          if (gq.indexOf('(l=') > -1) { // custom LH
                            customLH = true
                            customLHStr = gq.split('(l=')[1].split(')')[0].trim()
                            gq = gq.split(customLHStr).join('')
                            lh.push(customLHStr.split('_').join(' '))
                          }
                          if (gq.indexOf('(r=') > -1) { // custom RH
                            customRH = true
                            customRHStr = gq.split('(r=')[1].split(')')[0].trim()
                            gq = gq.split(customRHStr).join('')
                            rh.push(customRHStr.split('_').join(' '))
                          }
                        // }

                        // { FY Hui Pos
                          // if (gq.indexOf('()') > -1) 
                          //   prevFYHui = []
                          fyHuis = gq.getParentheticals()
                          gq = gq.removeParentheses()

                        // }

                        // { lyMapAndExtract (/, ~, etc.)
                          for (var j=0;j<gq.length;j++) {
                            if (lyMapAndExtract.indexOf(gq[j]) > -1 && gq2 == '')
                              gq1 += gq[j] == '\\' ? '\\\\' : gq[j]
                            else if (lyMapAndExtract.indexOf(gq[j]) > -1 && gq2 != '')
                              gq3 += gq[j] == '\\' ? '\\\\' : gq[j]
                            else
                              gq2 += gq[j] == '\\' ? '\\\\' : gq[j]
                          }
                          if (gq1 != '' && !customLH)
                            lh.push(gq1)
                          for (var k in lyMap) {
                            if (gq2.has(k)) {
                              if (lyMap[k].type == 'rh' && !customRH) {
                                rh.push(lyMap[k].value)
                              }
                              else if (lyMap[k].type == 'lh' && ! customLH) {
                                lh.push(lyMap[k].value)
                              }
                              else if (lyMap[k].type == 'str') {
                                str.push(lyMap[k].value)
                              }
                            }
                          }
                          if (gq3 != '' && !customLH)
                            lh.push(gq3)
                        // }

                      }
                      if (str.length == 0) 
                        str = prevStr
                      prevStr = str
                    // }
                    guqin[i] = {
                      note: pitchArr,
                      beat: beatArr,
                      str: str,
                      rh: rh,
                      lh: lh
                    }

                    // { Create the LilyPond note string
                      if (startSlur) {
                        lySong += "("
                        startSlur = false
                      }
                      else if (endSlur) {
                        lySong += ") "
                        endSlur = false
                      }


                      if (startGliss) {
                        lySong += "\\grace { "
                        startGliss = false
                      }
                      else if (endGliss) {
                        lySong += " } "
                        endGliss = false
                      }

                      if (note[0]=="|") {
                        lySong += '\\bar "' + note.split(':')[0] + '"'
                      }
                      else if (note[0]=="$") {
                        lySong += '\\glissando '
                      }
                      else if (note[0]=="=") {
                        lySong += '~ '
                      }
                      else {
                        if (pitchArr[0] == undefined) {
                          console.log('error', i, song[i],  pitchArr)
                          alert(`error parsing note on line ${songLineIdx[i]+1}: ${song[i]}`)
                          $('.rendering').hide()
                          return
                        }
                        else {
                          if (lyPitches.indexOf(pitchArr[0][0]) > -1) {
                            if (pitchArr.length > 1) { // Chord
                              lySong += '<'
                              for (var j=0;j<pitchArr.length;j++) {
                                lySong += pitchArr[j] + '\\' + str[j]
                              }
                              lySong += '>'
                              lySong += beatArr.length > 0 ? beatArr[0] : ""
                            }
                            else if (pitchArr.length == 1) { // Single Note
                              lySong += pitchArr[0] 
                              lySong += beatArr.length > 0 ? beatArr[0] : "" 
                              lySong += '\\' + str[0]
                            }
                            if (rh.length > 0) {
                              var currRFH = rh.join('')
                              if (gq.indexOf('!') == -1 && getNumOnly(currRFH) == prevRHF) {
                                lySong +=  '^"' + removeNums(currRFH)  + '"'
                              }
                              else {
                                lySong +=  '^"' + currRFH + '"'
                                prevRHF = getNumOnly(currRFH)
                              }
                            }
                            lySong +=  lh.length > 0 ? '_"' + lh.join('') + '"' : ""
                          }
                          else if (lyFanYins.indexOf(pitchArr[0][0]) > -1)  {
                            // if (fyHuis.length == 0) 
                            //   fyHuis = prevFYHui
                            // else
                            //   prevFYHui = fyHuis
                            if (pitchArr.length > 1) { // Fan Yin Chord
                              lySong += '<<'
                              for (var j=0;j<pitchArr.length;j++) { 
                                lySong += ' \\fy '
                                if (fyHuis[j] != undefined) 
                                  lySong += '#' + fyHuis[j] + ' '
                                else {
                                  var fyhPossibilities = getHarmonicPositions(pitchArr[j], str[j], tuning)
                                  var fyrMin = Math.min.apply(Math, fyhuirange) 
                                  var fyrMax = Math.max.apply(Math, fyhuirange) 
                                  var fyHuiPos = ''
                                  for (var k=0;k<fyhPossibilities.length;k++) {
                                    if (fyhPossibilities[k]>=fyrMin && fyhPossibilities[k]<=fyrMax)
                                      fyHuiPos = '#' + fyhPossibilities[k]
                                  }
                                  lySong += fyHuiPos + ' '
                                }
                                // if (fyhuirange != 0 && fyhuirange != "auto") {
                                //   lySong += '#' + fyhuirange + ' '
                                // }
                                lySong += pitchArr[j].toLowerCase()
                                if (j==0)
                                  lySong += beatArr.length > 0 ? beatArr[0] : "" 
                                lySong += '\\' + str[j]
                                if (j==0) {
                                  if (rh.length > 0) {
                                    var currRFH = rh.join('')
                                    if (gq.indexOf('!') == -1 && getNumOnly(currRFH) == prevRHF) {
                                      lySong +=  '^"' + removeNums(currRFH)  + '"'
                                    }
                                    else {
                                      lySong +=  '^"' + currRFH + '"'
                                      prevRHF = getNumOnly(currRFH)
                                    }
                                  }
                                  lySong +=  lh.length > 0 ? '_"' + lh.join('') + '"' : ""
                                }
                              }
                              lySong += '>>'
                            }
                            else if (pitchArr.length == 1) { // Fan Yin Solo Note
                              lySong += ' \\fy '
                              if (fyHuis.length > 0)
                                lySong += '#' + fyHuis[0] + ' '
                              else {
                                var fyhPossibilities = getHarmonicPositions(pitchArr[0], str[0], tuning)
                                console.log(song[i], fyhPossibilities)
                                var fyrMin = Math.min.apply(Math, fyhuirange) 
                                var fyrMax = Math.max.apply(Math, fyhuirange) 
                                var fyHuiPos = ''
                                if (fyhPossibilities != undefined)
                                  for (var k=0;k<fyhPossibilities.length;k++) {
                                    if (fyhPossibilities[k]>=fyrMin && fyhPossibilities[k]<=fyrMax)
                                      fyHuiPos = '#' + fyhPossibilities[k]
                                  }
                                lySong += fyHuiPos + ' '
                              }
                              // if (fyhuirange != 0 && fyhuirange != "auto") {
                              //   lySong += '#' + fyhuirange + ' '
                              // }
                              lySong += pitchArr[0].toLowerCase()
                              lySong += beatArr.length > 0 ? beatArr[0] : "" 
                              lySong += '\\' + str[0]
                              if (rh.length > 0) {
                                var currRFH = rh.join('')
                                if (gq.indexOf('!') == -1 && getNumOnly(currRFH) == prevRHF) {
                                  lySong +=  '^"' + removeNums(currRFH)  + '"'
                                }
                                else {
                                  lySong +=  '^"' + currRFH + '"'
                                  prevRHF = getNumOnly(currRFH)
                                }
                              }
                              lySong +=  lh.length > 0 ? '_"' + lh.join('') + '"' : ""
                            }
                          }
                        }
                      }
                      // left mute (TODO: chorded left mutes, this is pretty hard coded)
                      var lastNoteIdx = lySong.lastIndexOf(' ')
                      var lastNoteLy = lySong.substr(lastNoteIdx)
                      if (lastNoteLy.indexOf('X') > -1) {
                        lySong = lySong.substr(0, lastNoteIdx) + ' \\lm ' + lySong.substr(1+lastNoteIdx)
                      }
                      lySong += ' '
                    // }
                  }
                }
                if (inSlur) { // last line finishes a slide
                  lySong+=")"
                }

                lySong += '\n\n  \\bar "|."\n\n}\n\n'
                // lyTabSong = lySong
                //   .split('treble').join('moderntab')
                //   .split('bass').join('moderntab')
                //   .split('alto').join('moderntab')
                //   .split('tenor').join('moderntab')
                //   .split('song = {').join('tabsong = {')

                ly += lySong
                // ly += lyTabSong
              // }


              // { end context, etc. 
                ly +=lyStr3 + '\n\n'
                ly += `\\score {\n  ` + lyStr4 + '\n'
                if (showtimesig == 'no') {
                  ly += `  \\context { \\Staff \\omit TimeSignature }\n`
                }
                if (bars == 'manual') {
                  ly += `  \\context { \\Score automaticBars = ##f }\n`
                }
                ly +='  ' + lyStr5 + '\n  ' + lyStr6 + '\n  ' + lyStr7 + '\n}\n'
              // }

              ly = ly.split('\\bar "|" (').join('( \\bar "|" ')
            // }
            // console.log(guqin)
            // console.log(ly)
            console.log('rendered')
            // $('.lilypond').val(ly)
            lyCodeMirror.setValue(ly)
            // lyCodeMirror.refresh()
            // Cookies.set('shorthand', btoa($('.shorthand').val()))
          }

          if (to == "score") {
            console.log('lilypond > score')
            var data = { ly: from == "shorthand" ? ly : lyCodeMirror.getValue()  }
            console.log(data)
            // console.log({ly: lyCodeMirror.getValue() })
            $.ajax({
              url: '/renderly',
              method: 'POST',
              // data: { ly: $('.lilypond').val()  },
              data: data,
              success: function(output) {
                console.log(output)
                if (output.err != undefined) {
                  alert("LilyPond rendering error. Something went wrong while engraving the score using LilyPond. Logs:\n\n"+JSON.stringify(output.err))
                  $('.rendering').hide()
                }
                else if (output.stderr != '') {
                  alert("LilyPond rendering error. Something went wrong while engraving the score using LilyPond. Logs:\n\n"+output.stderr)
                  $('.rendering').hide()
                }
                else {
                  var tempId = output.tempId
                  var pngs = output.pngs
                  $('.download-pdf').attr('href', '/temp/' + tempId + '/music.pdf')
                  $('.download-midi').attr('href', '/temp/' + tempId + '/music.midi')
                  $('.midi-player').attr('src', '/temp/' + tempId + '/music.midi')
                  $('.score-pngs').empty()
                  for (var i=0;i<pngs.length;i++) {
                    var thisImg = $(`<img class="png" src="/temp/${tempId}/${pngs[i]}" />`)
                      .css('width', currWidth + '%')
                    $('.score-pngs').append(thisImg)
                      .append('<br />')
                  }
                  $('.score-container').show().attr('data-temp-id', tempId)
                }
                $('.rendering').hide()
              },
              error: function() {
                alert('Oops, something went wrong!')
                $('.rendering').hide()
              }
            })
          }
          else {
            $('.rendering').hide()
            $('.ly').show()
            lyCodeMirror.refresh()
            $('.ly-view').show().addClass('no-link').addClass('tab-active')
            $('.sh-view').show().removeClass('no-link').removeClass('tab-active')
            $('.sh').hide()
          }
        })

        function save(keepVersion) { 
          $.ajax({
            url: '/save',
            method: 'POST',
            data: { 
              id: session.id == undefined ? 0 : session.id,
              makenew: session.id == undefined || session.id == "new" ? true : false,
              version: session.version == undefined ? 0 : session.version,
              shortHandVal: shCodeMirror.getValue(), //$('.shorthand').val(),
              lilyPondVal: lyCodeMirror.getValue(), //$('.lilypond').val(),
              hasFiles: session.hasPDF || session.hasMIDI || session.hasPNG ? true : false,
              tempId: $('.score-container').attr('data-temp-id'),
              keepVersion: keepVersion
            },
            success: function (output) {
              window.location.href = '/nltabs/' + output.id + '/' + output.version
              localStorage.setItem('id', '')
            }
          })
        }
        $('.save').click(function() {
          var keepVersion = $(this).attr('data-keep-version') == undefined ? "no" : $(this).attr('data-keep-version')
          $.ajax({
            url: '/password/exists',
            method: 'POST',
            data: {id: session.id},
            success: function(output) {
              if (output.status == "yes") {
                var pw = prompt('Enter the password for this piece.\n\n(You can still "Save as New" link if you do not have the password)\n')
                if (pw == null)
                  return
                $.ajax({
                  url: '/password/check',
                  method: 'POST',
                  data: {id: session.id, pw: pw},
                  success: function(output2) {
                    if (output2.error) {
                      alert('Ah Ah Ah! You didn\'t say the magic word!\n\n(You can still "Save as New" link if you do not have the password)')
                    }
                    else if (output2.success == 'valid') {
                      save(keepVersion)
                    }
                  }
                })
              }
              else {
                save(keepVersion)
              }
            } 
          })    
        })
        $('.save-new').click(function() {
          $.ajax({
            url: '/save',
            method: 'POST',
            data: { 
              id: session.id == undefined ? 0 : session.id,
              makenew: true,
              version: session.version,
              shortHandVal: shCodeMirror.getValue(), //$('.shorthand').val(),
              lilyPondVal: lyCodeMirror.getValue(), //$('.lilypond').val(),
              hasFiles: session.hasPDF || session.hasMIDI || session.hasPNG ? true : false,
              tempId: $('.score-container').attr('data-temp-id')
            },
            success: function (output) {
              window.location.href = '/nltabs/' + output.id + '/' + output.version
              localStorage.setItem('id', '')
            }
          })
        })
        $('.new').click(function() {
          window.location.href = '/nltabs/'
        })
        document.addEventListener('keydown', e => {
          if (e.key === 's' && (e.metaKey || e.ctrlKey)) {
            e.preventDefault();
            $('.save-new-version').click()
          }
        });
        $('.lock').click(function() {
          // var localPW = JSON.parse(localStorage.getItem('passwords'))
          // if (localPW != undefined)
          //   localPW = localPW[session.id]
          $.ajax({
            url: '/password/exists',
            method: 'POST',
            data: {id: session.id},
            success: function(output) {
              if (output.status == "yes") {
                var oldPW = prompt('Enter the CURRENT password for this piece')
                if (oldPW == null)
                  return
                var newPW = prompt('Enter the NEW password for this piece')
                if (newPW == null)
                  return
                $.ajax({
                  url: '/password/set',
                  method: 'POST',
                  data: {id: session.id, oldPW: oldPW, newPW: newPW},
                  success: function(output2) {
                    if (output2.error) {
                      alert("Ah Ah Ah! You didn't say the magic word!")
                    }
                    else if (output2.success == 'password set') {
                      alert("Password is set")
                      $('.unlock').show()
                      $('.unlock').click(function() {
                        unlock()
                      })
                    }
                  }
                })
              }
              else {
                var newPW = prompt('Lock this piece with a password. Going forward, people will need this password to save new versions. They can still use Save As New to create their own IDs.')
                if (newPW == null)
                  return
                $.ajax({
                  url: '/password/set',
                  method: 'POST',
                  data: { id: session.id, newPW: newPW },
                  success: function(output2) {
                    if (output2.error) {
                      alert("Nah uh uh! You didn't say the magic word!")
                    }
                    else if (output2.success == 'password set') {
                      alert("Password is set")
                      $('.unlock').show()
                      $('.unlock').click(function() {
                        unlock()
                      })
                    }
                  }
                })
              }
            }
          })
        })
        if (session.id != 'new') {
          $.ajax({
            url: '/password/exists',
            method: 'POST',
            data: {id: session.id},
            success: function(output) {
              if (output.status == "yes") {
                $('.unlock').show()
                $('.unlock').click(function() {
                  unlock()
                })
              }
            }
          })  
        }
        function unlock() {
          var pw = prompt('Enter the password for this piece')
          if (pw == null)
            return
          $.ajax({
            url: '/password/unset',
            method: 'POST',
            data: {id: session.id, pw: pw},
            success: function(output2) {
              if (output2.error) {
                alert("Ah Ah Ah! You didn't say the magic word!")
              }
              else if (output2.success == 'password unset') {
                alert("Password is unset. Anybody can save and increment the versions now.")
                $('.unlock').hide()
              }
            }
          })
        }

        $('.sh-view').click(function() {
          $('.ly').hide()
          $('.sh').show()
          lyCodeMirror.refresh()
          $('.ly-view').show().removeClass('no-link')
          $('.sh-view').show().addClass('no-link')
          $('.sh-view').addClass('tab-active')
          $('.ly-view').removeClass('tab-active')
        })

        $('.ly-view').click(function() {
          $('.sh').hide()
          $('.ly').show()
          $('.ly-view').show().addClass('no-link')
          $('.sh-view').show().removeClass('no-link')
          $('.sh-view').removeClass('tab-active')
          $('.ly-view').addClass('tab-active')
        })

        // set score container height
        $('.score-pngs').css('height', window.innerHeight - $('.header').outerHeight(true) - $('.score-header').outerHeight(true) - 20 + 'px')
        $('.input-container-sh').css('height', window.innerHeight - $('.header').outerHeight(true) - $('.input-label').outerHeight(true) - $('.input-footer').outerHeight(true) - 20 + 'px')
        $('.input-container-ly').css('height', window.innerHeight - $('.header').outerHeight(true) - $('.input-label').outerHeight(true) - $('.input-footer').outerHeight(true) - 20 + 'px')
        $('.input-container-sh').css('width', $('.input-container-sh').width() + 'px')
        $('.input-container-ly').css('width', $('.input-container-ly').width() + 'px')

        shCodeMirror = CodeMirror.fromTextArea($('.shorthand')[0], {
            lineNumbers: true
        });
        lyCodeMirror = CodeMirror.fromTextArea($('.lilypond')[0], {
            lineNumbers: true
        });
        if (localStorage.getItem('id') == session.id && localStorage.getItem('shorthand') != session.shortHandVal) {
          if (confirm('Do you want to reload unsaved version?\n\nYou will need to re-render any changes.')) {
            shCodeMirror.setValue(localStorage.getItem('shorthand'))
            $('.unsaved').show()
          } else {
            shCodeMirror.setValue(session.shortHandVal)
            $('.unsaved').hide()
          }
        }
        else {
          shCodeMirror.setValue(session.shortHandVal)
          $('.unsaved').hide()
        }
        lyCodeMirror.setValue(session.lilyPondVal)
        $('.ly').hide()
        // $('.ly-view').hide()

        // autosave
        shCodeMirror.on('change', function() {
          if (shCodeMirror.getValue() != session.shortHandVal) {
            $('.unsaved').show()
            localStorage.setItem('shorthand', shCodeMirror.getValue())
            localStorage.setItem('id', session.id)
          }
          else {
            localStorage.setItem('shorthand', shCodeMirror.getValue())
            $('.unsaved').hide()
          }
        })

        // copy link
        $('.copy-link').click(function() {  
          console.log('sdf')
          var copyText = $(".link")[0]
          copyText.select();
          copyText.setSelectionRange(0, 99999); 
          navigator.clipboard.writeText(copyText.value);
          $('.copy-link').hide()
          $('.copied').show(); 
          $('.copied').fadeOut(2000, function() {
            $('.copy-link').show()
          })
        })
        // zooms
        var zoomVal = 1.15
        $('.zoom-in-score').click(function() {
          currWidth *= zoomVal
          $('.png').css('width', currWidth + '%')
        })
        $('.zoom-out-score').click(function() {
          currWidth /= zoomVal
          $('.png').css('width', currWidth + '%')
        })
      })
    </script>
    <style>
      textarea {
        white-space: pre;
        overflow-wrap: normal;
        overflow-x: scroll;
      }
      .score-container {
        display: none;
      }
      .score-pngs {
        border: solid 1px #BBB;
        padding: 10px;
        background: #EEE;
        overflow:  scroll;
      }
      .png {
        width:  100%;
        margin-bottom: 10px;
      }
      .lilypond-container {
        display: none;
      }
      .rendering {
        width: 100%;
        height:  100%;
        position:  fixed;
        background:  rgba(0,0,0,0.7);
        font-weight: bold;
        font-size: 48px;
        padding-top:  20%;
        text-align: center;
        color: #fff;
        z-index: 7013;
        display: none;
      }
      .CodeMirror {
        border: 1px solid #eee;
        height: 100%;
        width: 100%;
        font-size: 13px;
      }
      .input-container {
        height:  600px;
      }
      .no-link {
        color:  #000;
        pointer-events: none;
        cursor: default;
      }
      .unsaved { 
        display: none;
      }
      body {
        overscroll-behavior-x: none;
      }
      .midi-player {
        height:  20px;
      }
      .tab-active {
        border-radius: 10px 10px 0px 0px;
        border-top: solid 1px #bbb;
        border-right: solid 1px #bbb;
        border-left: solid 1px #bbb;
        padding: 10px;
      }
      .tab {
        border-radius: 10px 10px 0px 0px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class='rendering'>Rendering...</div>
    <nav class="nav"></nav>  
    </nav>    
    <div class="container-fluid">
      <div class="row">
        <div class="col">
          <div class="row">
            <div class="col">
              <label class="input-label">
                <a class="sh-view tab no-link tab-active" href="javascript:void(0)">Shorthand</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <a class="ly-view tab" href="javascript:void(0)">LilyPond</a>
              </label>
              <div class="input-container-sh sh"><textarea class="shorthand form-control"></textarea></div>
              <div class="input-container-ly ly"><textarea class="lilypond form-control"></textarea></div>
<!--                 <div class="sh"><textarea class="shorthand form-control"></textarea></div>
                <div class="ly"><textarea class="lilypond form-control"></textarea></div>
              </div> -->
              <div class="input-footer">
                <br />
                <button class="render sh btn btn-primary" data-to="score" data-from="shorthand">Render Score</button>
                <button class="render sh btn btn-link" data-to="lilypond" data-from="shorthand">Convert to LilyPond Code</button>
                <button class="render ly btn btn-primary" data-to="score" data-from="lilypond">Render Score</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <label class="score-header">Score
            <span class="score-container">
              <small>
                <input type="text" class="link form-control" style="display: none";/>
                &nbsp;&nbsp;
                <a class="copy-link" href="javascript:void(0)">Copy Link</a>
                <span class="copied">Copied!</span>
                &nbsp;&nbsp;
                <a href="" class="download-pdf">PDF</a>
                &nbsp;&nbsp;
                <a href="" class="download-midi">MIDI</a>
                &nbsp;&nbsp;
                <midi-player class="midi-player" src="" sound-font></midi-player>
                <a href="javascript:void(0)" class="zoom-in-score"><i class="fas fa-search-plus"></i></a>
                <a href="javascript:void(0)" class="zoom-out-score"><i class="fas fa-search-minus"></i></a>
                <!-- <span class="show-on-score navbar-text" style="color: #fff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Link:&nbsp;&nbsp;</span> -->

<!-- <midi-visualizer type="piano-roll" id="myVisualizer"></midi-visualizer> -->
              </small>
            </span>
          </label>
          <div class="score-container">
            <div class="score-pngs"></div>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
